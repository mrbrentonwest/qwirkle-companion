# Milestone v1.0: Game Persistence & History

**Status:** SHIPPED 2026-01-18
**Phases:** 1-3
**Total Plans:** 8

## Overview

| # | Phase | Goal | Requirements |
|---|-------|------|--------------|
| 1 | Identity | Users can identify themselves with a passphrase | IDEN-01, IDEN-02, IDEN-03 |
| 2 | Persistence | Games auto-save and survive page refreshes | PERS-01, PERS-02, PERS-03 |
| 3 | Home & History | Users see game history and navigate from home screen | HOME-01, HOME-02, HOME-03, HIST-01, HIST-02, HIST-03, HIST-04 |

## Phases

### Phase 1: Identity

**Goal:** Users can identify themselves with a passphrase that persists on their device
**Depends on:** None (foundation phase)
**Plans:** 2 plans

Plans:
- [x] 01-01-PLAN.md — Foundation & Context (localStorage hook, hashing, identity context)
- [x] 01-02-PLAN.md — UI & Integration (passphrase dialog, settings sheet, avatar, wiring)

**Details:**
- useLocalStorage hook with SSR safety and hydration state
- hashPassphrase using Web Crypto SHA-256
- IdentityContext/useIdentity for app-wide identity state
- PassphraseDialog for first-time users (non-dismissible)
- SettingsSheet for passphrase changes with confirmation
- UserAvatar in header to access settings

**Completed:** 2026-01-17

---

### Phase 2: Persistence

**Goal:** Games auto-save to Firestore and survive page refreshes
**Depends on:** Phase 1 (need user identity to associate games)
**Plans:** 3 plans

Plans:
- [x] 02-01-PLAN.md — Firebase Infrastructure (initialization, anonymous auth)
- [x] 02-02-PLAN.md — Firestore Game Operations (CRUD, useGamePersistence hook)
- [x] 02-03-PLAN.md — Integration & Verification (wire into page.tsx, security rules, user verification)

**Details:**
- Firebase singleton with db and auth exports
- Anonymous Auth integrated into IdentityContext
- saveActiveGame/loadActiveGame/clearActiveGame CRUD operations
- useGamePersistence hook with debounced save (500ms)
- Auto-save on every gameState change via useEffect
- Firestore security rules for user data isolation
- Document path: `users/{userId}/activeGame/current`

**Completed:** 2026-01-18

---

### Phase 3: Home & History

**Goal:** Users can see their game history and navigate to games from a home screen
**Depends on:** Phase 2 (need persisted games to display history)
**Plans:** 3 plans

Plans:
- [x] 03-01-PLAN.md — Firestore Game History Operations (types extension, archiveGame, getGameHistory)
- [x] 03-02-PLAN.md — Home Screen Components (useGameHistory hook, HomeScreen, GameHistoryList, GameHistoryItem, EmptyHistory)
- [x] 03-03-PLAN.md — Integration & Verification (view switching, game archiving, GameDetailDialog, user verification)

**Details:**
- StoredGameState type with completedAt field
- archiveGame/getGameHistory Firestore operations
- useGameHistory hook for fetching history
- HomeScreen with Continue Game (prominent), New Game, Recent Games
- GameHistoryList/GameHistoryItem/EmptyHistory components
- GameDetailDialog for turn-by-turn breakdown
- View switching between home and game screens
- Game archiving on end with return to home

**Completed:** 2026-01-18

---

## Dependency Graph

```
Phase 1: Identity
    |
    v
Phase 2: Persistence
    |
    v
Phase 3: Home & History
```

Linear dependency chain - each phase builds on the previous.

---

## Milestone Summary

**Key Decisions:**
- useLocalStorage returns 4-tuple with isHydrated for loading UI
- Passphrase normalized (trim + lowercase) before hashing for consistency
- Sign in anonymously only after passphrase set (match identity flow)
- 500ms debounce for Firestore saves (prevent rate limit)
- Security rules allow any auth user to any userId path (SHA-256 unguessability)
- View state controls home vs game display (not gameState existence)
- Archive game before clearing active state

**Issues Resolved:**
- SSR hydration errors with localStorage (useEffect pattern)
- Firebase hot-reload issues (getApps() check)
- Flash of empty state on load (wait for persistence)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

*For current project status, see .planning/ROADMAP.md*
*Archived: 2026-01-18*
