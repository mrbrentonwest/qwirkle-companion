---
phase: 01-identity
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/identity/passphrase-dialog.tsx
  - src/components/identity/settings-sheet.tsx
  - src/components/identity/user-avatar.tsx
  - src/app/layout.tsx
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees passphrase prompt on first visit"
    - "User is not prompted again on subsequent visits after entering passphrase"
    - "User can access settings by tapping avatar"
    - "User can change passphrase from settings"
    - "Changed passphrase persists after page refresh"
  artifacts:
    - path: "src/components/identity/passphrase-dialog.tsx"
      provides: "Initial passphrase entry modal"
      exports: ["PassphraseDialog"]
    - path: "src/components/identity/settings-sheet.tsx"
      provides: "Settings overlay with change passphrase"
      exports: ["SettingsSheet"]
    - path: "src/components/identity/user-avatar.tsx"
      provides: "Avatar button that opens settings"
      exports: ["UserAvatar"]
    - path: "src/app/layout.tsx"
      provides: "IdentityProvider wrapper"
      contains: "IdentityProvider"
  key_links:
    - from: "src/components/identity/passphrase-dialog.tsx"
      to: "src/contexts/identity-context.tsx"
      via: "useIdentity hook"
      pattern: "useIdentity\\(\\)"
    - from: "src/components/identity/settings-sheet.tsx"
      to: "src/contexts/identity-context.tsx"
      via: "useIdentity hook"
      pattern: "useIdentity\\(\\)"
    - from: "src/app/layout.tsx"
      to: "src/contexts/identity-context.tsx"
      via: "IdentityProvider wrapper"
      pattern: "<IdentityProvider>"
---

<objective>
Build identity UI components and integrate them into the app: passphrase entry dialog, settings sheet, and user avatar trigger.

Purpose: Deliver the complete user-facing identity feature. First-time users see a passphrase prompt; returning users see their avatar and can access settings to change their passphrase.

Output: Working identity flow where users can enter, persist, and change their passphrase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-identity/01-RESEARCH.md
@.planning/phases/01-identity/01-CONTEXT.md
@.planning/phases/01-identity/01-01-SUMMARY.md

@src/contexts/identity-context.tsx
@src/components/ui/dialog.tsx
@src/components/ui/sheet.tsx
@src/components/ui/avatar.tsx
@src/components/ui/form.tsx
@src/components/ui/input.tsx
@src/app/layout.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create identity UI components</name>
  <files>
    src/components/identity/passphrase-dialog.tsx
    src/components/identity/settings-sheet.tsx
    src/components/identity/user-avatar.tsx
  </files>
  <action>
Create three identity components using existing shadcn/ui primitives:

1. Create `src/components/identity/passphrase-dialog.tsx`:
   - Non-dismissible Dialog for first-time users (no close button, no backdrop click)
   - Use react-hook-form + Zod for validation (min 4 chars, max 100)
   - Single passphrase field with show/hide toggle button
   - "Continue" submit button
   - On submit: call setPassphrase from useIdentity, dialog closes automatically
   - Props: open (controlled by parent based on !isIdentified && !isLoading)
   - Use DialogContent without the X close button (render children only, no DialogClose)
   - Follow form pattern from RESEARCH.md Code Examples

2. Create `src/components/identity/settings-sheet.tsx`:
   - Sheet sliding from right side
   - Header: "Settings" title, "Manage your identity" description
   - Change passphrase form:
     - New passphrase field (min 4 chars)
     - Confirm passphrase field (must match)
     - Show/hide toggles on both fields
     - Use Zod refine to validate match
     - Submit button "Update Passphrase"
   - On successful change: show toast "Passphrase updated", close sheet
   - Props: open, onOpenChange
   - Per CONTEXT.md: require typing new passphrase twice to confirm

3. Create `src/components/identity/user-avatar.tsx`:
   - Button wrapping Avatar component
   - AvatarFallback with User icon from lucide-react
   - Focus ring styles for accessibility
   - Props: onClick (to open settings sheet)
   - Follow avatar pattern from RESEARCH.md Code Examples
  </action>
  <verify>
  - TypeScript compiles: `npx tsc --noEmit`
  - All three components export correctly
  </verify>
  <done>
  - PassphraseDialog validates and submits passphrase
  - SettingsSheet allows changing passphrase with confirmation
  - UserAvatar renders clickable avatar with User icon fallback
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate identity into app layout and page</name>
  <files>
    src/app/layout.tsx
    src/app/page.tsx
  </files>
  <action>
Wire identity components into the application:

1. Update `src/app/layout.tsx`:
   - Import IdentityProvider from @/contexts/identity-context
   - Wrap {children} with IdentityProvider (inside body, around children and Toaster)
   - Keep 'use client' since IdentityProvider is client component
   - Note: layout.tsx doesn't have 'use client' currently, need to either:
     - Add 'use client' to layout.tsx, OR
     - Create a client wrapper component
   - Recommendation: Create src/app/providers.tsx as client component that wraps IdentityProvider, then import in layout.tsx (server component friendly)

2. Create `src/app/providers.tsx` (if needed):
   - 'use client' directive
   - Export Providers component that wraps children with IdentityProvider
   - This allows layout.tsx to remain a server component

3. Update `src/app/page.tsx`:
   - Import useIdentity hook
   - Import PassphraseDialog, SettingsSheet, UserAvatar
   - Add state for settings sheet: const [settingsOpen, setSettingsOpen] = useState(false)
   - Get { isLoading, isIdentified } from useIdentity()
   - Add UserAvatar to header (right side, next to round button area)
   - Add PassphraseDialog with open={!isIdentified && !isLoading}
   - Add SettingsSheet with open={settingsOpen} onOpenChange={setSettingsOpen}
   - Wire UserAvatar onClick to open settings sheet
   - During isLoading, avatar can show skeleton or be hidden

Header placement per CONTEXT.md: avatar in header area for settings access
  </action>
  <verify>
  - App starts without errors: `npm run dev` and check localhost:9002
  - First visit shows passphrase dialog
  - After entering passphrase, dialog closes and avatar appears
  - Tapping avatar opens settings sheet
  - Changing passphrase works and persists after refresh
  </verify>
  <done>
  - IdentityProvider wraps app
  - PassphraseDialog appears for unidentified users
  - UserAvatar in header opens SettingsSheet
  - Full identity flow works end-to-end
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete identity system with passphrase entry, persistence, and settings</what-built>
  <how-to-verify>
    1. Open app in browser (clear localStorage first via DevTools > Application > Local Storage > Clear)
    2. Verify: Passphrase dialog appears and cannot be dismissed without entering passphrase
    3. Enter a passphrase (e.g., "test1234") and click Continue
    4. Verify: Dialog closes, avatar appears in header
    5. Refresh the page
    6. Verify: No passphrase dialog appears (identity persisted)
    7. Tap the avatar in header
    8. Verify: Settings sheet slides in from right
    9. Enter new passphrase in both fields (e.g., "newpass123")
    10. Click "Update Passphrase"
    11. Verify: Toast shows "Passphrase updated", sheet closes
    12. Refresh page again
    13. Verify: Still no passphrase dialog (new passphrase persisted)
    14. Check DevTools > Application > Local Storage for 'qwirkle-identity' key
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 01 requirements check:
- IDEN-01: User can enter a passphrase to identify themselves (PassphraseDialog)
- IDEN-02: Passphrase is remembered on the device (localStorage via useLocalStorage)
- IDEN-03: User can change their passphrase from settings (SettingsSheet)

All requirements covered by this plan.
</verification>

<success_criteria>
- First-time users see non-dismissible passphrase dialog
- Returning users bypass dialog (identity in localStorage)
- Avatar appears in header after identification
- Tapping avatar opens settings sheet
- Changing passphrase requires confirmation (type twice)
- Changed passphrase persists after refresh
- No hydration errors in console
</success_criteria>

<output>
After completion, create `.planning/phases/01-identity/01-02-SUMMARY.md`
</output>
