---
phase: 03-home-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types.ts
  - src/lib/firestore-game.ts
autonomous: true

must_haves:
  truths:
    - "Completed games can be saved to gameHistory subcollection"
    - "Game history can be queried with most recent first"
    - "StoredGameState includes completedAt timestamp"
  artifacts:
    - path: "src/lib/types.ts"
      provides: "StoredGameState type with completedAt field"
      contains: "completedAt"
    - path: "src/lib/firestore-game.ts"
      provides: "archiveGame and getGameHistory functions"
      exports: ["archiveGame", "getGameHistory"]
  key_links:
    - from: "src/lib/firestore-game.ts"
      to: "firebase/firestore"
      via: "addDoc, collection, getDocs, query, orderBy, limit"
      pattern: "addDoc|getDocs|orderBy"
---

<objective>
Add Firestore operations for game history storage and retrieval.

Purpose: Enable completed games to be archived to a `gameHistory` subcollection and queried for display on the home screen. This is the data layer foundation for all history features.

Output: Extended types and Firestore CRUD functions for game history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-home-history/03-RESEARCH.md

# Existing code to extend
@src/lib/types.ts
@src/lib/firestore-game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types for stored game state</name>
  <files>src/lib/types.ts</files>
  <action>
Update the types.ts file to export a StoredGameState interface.

This interface extends GameState with optional id (for Firestore document ID), required createdAt and updatedAt (ISO strings), and optional completedAt (ISO string, present only for archived games).

The StoredGameState interface should be:
```typescript
export interface StoredGameState extends GameState {
  id?: string;           // Firestore document ID (set when retrieved)
  createdAt: string;     // ISO timestamp when game started
  updatedAt: string;     // ISO timestamp of last update
  completedAt?: string;  // ISO timestamp when game ended (history only)
}
```

Note: The existing StoredGameState in firestore-game.ts should be removed in favor of this shared type definition.
  </action>
  <verify>Run `npm run typecheck` - should pass without errors.</verify>
  <done>StoredGameState interface exported from types.ts with id, createdAt, updatedAt, and completedAt fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add game history Firestore operations</name>
  <files>src/lib/firestore-game.ts</files>
  <action>
Extend firestore-game.ts with two new functions and update existing imports:

1. Update the import at the top to include collection, addDoc, query, orderBy, limit, getDocs from firebase/firestore.

2. Remove the local StoredGameState interface and import it from @/lib/types instead.

3. Add archiveGame function:
```typescript
/**
 * Archive a completed game to the gameHistory subcollection
 * Path: users/{userId}/gameHistory/{auto-id}
 */
export async function archiveGame(userId: string, gameState: GameState): Promise<string> {
  if (!db) {
    throw new Error('Firestore not initialized');
  }
  const historyRef = collection(db, 'users', userId, 'gameHistory');
  const now = new Date().toISOString();

  const docRef = await addDoc(historyRef, {
    ...gameState,
    createdAt: now, // Will be overwritten if gameState has createdAt
    updatedAt: now,
    completedAt: now,
  });

  return docRef.id;
}
```

4. Add getGameHistory function:
```typescript
/**
 * Fetch game history ordered by completion date (most recent first)
 * Returns up to maxGames completed games
 */
export async function getGameHistory(userId: string, maxGames = 10): Promise<StoredGameState[]> {
  if (!db) {
    throw new Error('Firestore not initialized');
  }
  const historyRef = collection(db, 'users', userId, 'gameHistory');
  const q = query(
    historyRef,
    orderBy('completedAt', 'desc'),
    limit(maxGames)
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  } as StoredGameState));
}
```

Keep the existing saveActiveGame, loadActiveGame, and clearActiveGame functions unchanged (except for the StoredGameState import update).
  </action>
  <verify>Run `npm run typecheck` - should pass. The new functions should be importable.</verify>
  <done>archiveGame and getGameHistory functions exported from firestore-game.ts. Types import shared StoredGameState from types.ts.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- StoredGameState is exported from src/lib/types.ts
- archiveGame and getGameHistory are exported from src/lib/firestore-game.ts
- No duplicate type definitions between files
</verification>

<success_criteria>
- StoredGameState type available with completedAt optional field
- archiveGame writes to users/{userId}/gameHistory subcollection with auto-generated ID
- getGameHistory queries gameHistory ordered by completedAt desc, limited to 10 by default
- All existing persistence functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-home-history/03-01-SUMMARY.md`
</output>
